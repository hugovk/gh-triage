#!/usr/bin/env python3
"""gh-spam: Close an issue or PR as spam.

Apply 'invalid' and 'spam' labels if they exist, change the title to 'spam',
and close the issue or PR.
"""

import argparse
import json
import shlex
import subprocess


def run(cmd: str, dry_run: bool = False) -> tuple[int, str, str]:
    """Run a command and return (returncode, stdout, stderr)."""
    if dry_run:
        print(f"  {cmd}")
        return 0, "", ""
    result = subprocess.run(shlex.split(cmd), capture_output=True, text=True)
    return result.returncode, result.stdout, result.stderr


def main() -> None:
    parser = argparse.ArgumentParser(
        description=__doc__, formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument("target", help="Issue or PR number or URL")
    parser.add_argument(
        "-n",
        "--dry-run",
        action="store_true",
        help="Show what would be done without making changes",
    )
    args = parser.parse_args()

    target = args.target
    dry_run = args.dry_run

    # Determine if it's a PR or issue
    return_code, _, _ = run(f"gh pr view {target}")
    is_pr = return_code == 0

    # Get repo labels
    _, labels_json, _ = run("gh label list --json name --limit 500")
    repo_labels = json.loads(labels_json) if labels_json else []

    # Find invalid and spam labels (case insensitive)
    invalid_label = None
    spam_label = None
    for label in repo_labels:
        name = label["name"]
        if name.lower() == "invalid":
            invalid_label = name
        elif name.lower() == "spam":
            spam_label = name

    # Build labels to add
    labels_to_add = [l for l in [invalid_label, spam_label] if l]

    kind = "PR" if is_pr else "issue"
    cmd = "pr" if is_pr else "issue"

    if dry_run:
        print(f"Would run on {kind} {target}:")

    if labels_to_add:
        run(f"gh {cmd} edit {target} --add-label {','.join(labels_to_add)}", dry_run)

    run(f"gh {cmd} edit {target} --title spam", dry_run)

    reason = "" if is_pr else "--reason 'spam'"
    run(f"gh {cmd} close {target} {reason}", dry_run)

    if not dry_run:
        print("Closed as spam")


if __name__ == "__main__":
    main()
